---
interface AppProps {
  id: string;
  name: string;
  summary: string;
  icon?: string;
  flathubUrl?: string;
  isVerified?: boolean;
  installsLastMonth?: number;
  currentReleaseDate?: string;
  packageType: string;
}

interface Props {
  apps: AppProps[];
}

const { apps } = Astro.props;

/**
 * Daily rotation algorithm:
 * 1. Filter for verified apps with >1000 installs and recent updates
 * 2. Use deterministic seed based on current date (YYYY-MM-DD)
 * 3. Select one app per day using seeded random
 */
function getFeaturedApp(apps: AppProps[]): AppProps | null {
  // Filter for eligible apps:
  // - Flatpak apps only (not Homebrew or OS releases)
  // - Verified apps (when available)
  // - Apps with >1000 installs (when data available)
  // - Apps with recent updates (within last 90 days, when available)
  const now = new Date();
  const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
  
  let eligibleApps = apps.filter(app => {
    // Must be a Flatpak
    if (app.packageType !== 'flatpak') return false;
    
    // Prefer verified apps, but don't require it if none exist
    // Include apps with >1000 installs if data is available
    const meetsInstallThreshold = !app.installsLastMonth || app.installsLastMonth > 1000;
    
    // Check if recently updated (if date is available)
    let isRecentlyUpdated = true;
    if (app.currentReleaseDate) {
      try {
        const releaseDate = new Date(app.currentReleaseDate);
        isRecentlyUpdated = releaseDate >= ninetyDaysAgo;
      } catch {
        // If date parsing fails, include the app
        isRecentlyUpdated = true;
      }
    }
    
    return meetsInstallThreshold && isRecentlyUpdated;
  });
  
  // If no eligible apps after strict filtering, fall back to all Flatpak apps
  if (eligibleApps.length === 0) {
    eligibleApps = apps.filter(app => app.packageType === 'flatpak');
  }
  
  if (eligibleApps.length === 0) {
    return null;
  }
  
  // Deterministic selection based on current date
  // This ensures the same app is shown all day, but changes daily
  const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD format
  const seed = hashString(dateStr);
  const index = seed % eligibleApps.length;
  
  return eligibleApps[index];
}

/**
 * Simple hash function for deterministic random selection
 */
function hashString(str: string): number {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  return Math.abs(hash);
}

const featuredApp = getFeaturedApp(apps);
---

{featuredApp && (
  <div class="featured-banner">
    <div class="featured-label">
      <span class="star-icon">⭐</span>
      <span>Featured Today</span>
    </div>
    
    <a href={featuredApp.flathubUrl || '#'} target="_blank" rel="noopener" class="featured-content">
      <div class="featured-app-info">
        {featuredApp.icon && (
          <img 
            src={featuredApp.icon} 
            alt={`${featuredApp.name} icon`} 
            class="featured-icon"
          />
        )}
        
        <div class="featured-text">
          <div class="featured-name">
            {featuredApp.name}
            {featuredApp.isVerified && (
              <span class="verified-badge" title="Verified app">✓</span>
            )}
          </div>
          <p class="featured-summary">{featuredApp.summary}</p>
        </div>
      </div>
      
      <button class="featured-cta" type="button">
        View App
        <span class="arrow">→</span>
      </button>
    </a>
  </div>
)}

<style>
  .featured-banner {
    background: linear-gradient(135deg, #7b2ff7 0%, #4a90e2 100%);
    border-radius: 8px;
    padding: 1.25rem;
    box-shadow: 0 4px 12px rgba(123, 47, 247, 0.3);
    transition: transform 0.2s, box-shadow 0.2s;
    overflow: hidden;
    position: relative;
  }
  
  .featured-banner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
    pointer-events: none;
  }
  
  .featured-banner:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(123, 47, 247, 0.4);
  }
  
  .featured-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 0.75rem;
  }
  
  .star-icon {
    font-size: 1rem;
  }
  
  .featured-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    text-decoration: none;
    color: white;
    position: relative;
    z-index: 1;
  }
  
  .featured-app-info {
    display: flex;
    gap: 1rem;
    align-items: start;
  }
  
  .featured-icon {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    object-fit: contain;
    background: rgba(255, 255, 255, 0.1);
    padding: 2px;
    flex-shrink: 0;
  }
  
  .featured-text {
    flex: 1;
    min-width: 0;
  }
  
  .featured-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: white;
    margin-bottom: 0.375rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    line-height: 1.3;
  }
  
  .verified-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.25);
    color: white;
    border-radius: 50%;
    width: 1.125rem;
    height: 1.125rem;
    font-size: 0.75rem;
    font-weight: bold;
    flex-shrink: 0;
  }
  
  .featured-summary {
    font-size: 0.875rem;
    line-height: 1.5;
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .featured-cta {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    color: white;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    backdrop-filter: blur(10px);
    align-self: flex-start;
  }
  
  .featured-cta:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateX(2px);
  }
  
  .arrow {
    font-size: 1rem;
    transition: transform 0.2s;
  }
  
  .featured-cta:hover .arrow {
    transform: translateX(3px);
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .featured-banner {
      padding: 1rem;
    }
    
    .featured-icon {
      width: 40px;
      height: 40px;
    }
    
    .featured-name {
      font-size: 1rem;
    }
    
    .featured-summary {
      font-size: 0.8125rem;
    }
  }
</style>
